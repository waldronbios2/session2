---
title: "Sessions 2-3 lab exercise: Analysis of contraceptive use data"
author: "Levi Waldron"
institute: "CUNY SPH Biostatistics 2"
output:
  html_document:
    toc: yes
    df_print: paged
    theme: cerulean
    number_sections: yes
---

*Warning*: This lab is long! But it covers methods that you can use 
throughout the course and on all kinds of regression. It will be the last
lab of the first quarter of the course, because you can spend a couple weeks
working through and understanding the contents of this lab.

**Learning objectives**

1. gain additional familiarity with R, including `dplyr` and `ggplot2`
2. perform exploratory data analysis in R
3. perform and interpret logistic regression
    + interpret logistic regression coefficients
    + make predictions based on a logistic regression model
4. perform and interpret likelihood ratio test

**Questions**

1. Load the contraceptive use dataset, create a summary table, and a barplot.
2. What is the mean fraction of women using birth control for each age group? Each education level? For women who do or don't want more children?
     - Hint: look at the "data wrangling" cheat sheet functions `mutate`, `group_by`, and `summarize`
3. Based on ```fit1```, write on paper the model for expected probability of using birth control.  Don't forget the logit function.
4. Based on ```fit1```, what is the expected probability of an individual 25-29 years old, with high education, who wants more children, using birth control? Calculate it manually, and using `predict(fit1)`
5. Based on ```fit1```: Relative to women under 25 who want to have children, what is the predicted increase in odds that a woman 40-49 years old who does _not_ want to have children will be taking birth control?
6. Using a likelihood ratio test, is there evidence that a model with interactions improves on ```fit1``` (no interactions)?
7. Which, if any, variables have the strongest interactions?
8. Looking at the effect of age only, consider contrasts between *every pair* of age groups. Between which age groups is the contrast significant?

# Load and explore the contraceptive use data

Load the data from http://data.princeton.edu/wws509/datasets/#cuse. From this page:
> These data show the distribution of 1607 currently married and fecund women interviewed in the Fiji Fertility Survey, according to age, education, desire for more children and current use of contraception.

Unlike in the lecture, here I demonstrate reading the dataset using the *readr* package. It identifies some warnings because the header of this file has extra spaces at the end which appear like an extra column, making it appear like the dataset has 6 columns instead of 5. But the dataset reads with 5 columns as we want it to anyways, because I chose to skip the blank column 6 in the graphical interface (which added the code `X6 = col_skip()` below). *readr* is good for identifying problems like this in text data files.

```{r}
# traditional method for loading data:
# cuse <- read.table("cuse.dat", header=TRUE)
# Using readr package with "File - Import Dataset" and manually setting factor levels.
# Note, you don't have to write all this code by hand! It was produced by the File - Import Dataset helper.
library(readr)
cuse <- read_table2("cuse.dat",
    col_types = cols(
      age = col_factor(levels = c("<25", "25-29", "30-39", "40-49")),
      education = col_factor(levels = c("low", "high")),
      wantsMore = col_factor(levels = c("no", "yes")),
      X6 = col_skip()
    )
  )
summary(cuse)
```

## Epi table 1

Here's a simple way to create the summary table that is required for your assignments,
and for any epidemiological analysis you do. The text format is fine, and convenient
for moving into another pubication or presentation document. See the [tableone vignette](https://cran.r-project.org/web/packages/tableone/vignettes/introduction.html) 
for more complex usage and for instructions on how to export directly to an Excel
or Word table.


```{r}
# Note the use of `tableone::` to specify that `CreateTableOne` comes from the 
# tableone library without actually loading the library.
tableone::CreateTableOne(data = cuse)
```
**Table 1: characteristics of the contraceptive use dataset**

## A basic barplot

See the [Data Visualization Cheatsheet](https://github.com/rstudio/cheatsheets/raw/master/data-visualization-2.1.pdf) for help on enhancing this barplot.

First let's do some work on the data to get it in shape for plotting. I do these 
one step at a time to show what's happening, but you could also do chain these
steps all together using the pipe operator (`%>%`).

First, group by age and whether the participant reports wanting more children, and 
sum the number wanting or not wanting more children in each of these groups. Also
rename "notUsing" to "not using" to make a nicer legend later.
```{r}
library(tidyverse)
cusebyage <- group_by(cuse, age, wantsMore) %>%
    summarise(using = sum(using), "not using" = sum(notUsing))
print(cusebyage)
```

Next, pivot this into a longer table by putting the "using" and "not using" columns
into a single column called "contraceptive".
```{r}
cusebyage <- pivot_longer(cusebyage,
      cols = using:"not using",
      values_to = "n",
      names_to = "contraceptive")
cusebyage
```

Finally, calculate the percentages reporting contraceptive use in each group. 
This will provide an alternative way to plot the data.
```{r}
cusebyage <- group_by(cusebyage, age, wantsMore) %>% 
    mutate(percent = n / sum(n) * 100)
cusebyage
```

Now, make a sort of fancy greyscale barplot using ggplot2. You can make a nice
plot without using nearly so many options, but I want to demonstrate the flexibility
of making a bar plot with ggplot2. 
```{r}
ggplot(cusebyage, aes(x = wantsMore, weight = n, fill = contraceptive)) +
  # create a stacked bar plot, where the values provided are counts/frequencies,
  # and use black outlines for the bars.
  geom_bar(position = "stack", stat = "count", color = "black") + 
  # use facet_grid to separate the plots by age group
  facet_grid(.~age, labeller = label_both) +
  labs(title = "Contraceptive usage counts",
       subtitle = "in Contraceptive Use dataset",
       caption = "Contraceptive use in study sample") + 
  xlab("Wants more children?") + 
  ylab("Number of Participants") +
  # there are lots of scale_fill_* options for automatic color schemes, but I 
  # just want to specify the colors manually here.
  scale_fill_manual(values=c("white", "grey")) +
  theme_bw()
```

**Figure 1: contraceptive use in the study sample.** Bar plot is organized by age 
group and stacked by self-report of whether participant wants more children. The 
fraction of women wanting more children decreases with age, becoming a minority in 
the 40-49 age group. One unexpected observation in this bar chart is that in the
<25 age group, those reporting wanting more children appear *more* likely to 
report using contraceptives. Is this the case? One way to make this more visually
clear would be to use percentages, instead of counts, on the vertical scale. Try
this, by changing `weight = n` to `weight = percent` to use the "percent" column
as heights instead of the "n" column. While you're at it, change the y label to
reflect this change.


*Note*: The caption option in *ggplot2* is suitable for smaller, embedded captions. But
for publication the caption usually needs to be in separated text.

# What is the mean fraction of women using birth control for...

What is the mean fraction of women using birth control for each age group? Each education level? For women who do or don't want more children?
     - Hint: look at the ["Data Transformation Cheatsheet"](https://github.com/rstudio/cheatsheets/raw/master/data-transformation.pdf) functions `mutate`, `group_by`, and `summarize`. This is one of several very handy cheatsheets produced
     by RStudio, see https://rstudio.com/resources/cheatsheets/ for a list.
     

**Solution**

First create a new column containing the fraction using contraception:

```{r}
cuse2 <- mutate(cuse, fracusing = using / (using + notUsing))
cuse2
```

Now, group and summarize by age:

```{r}
cuse2 %>% group_by(age) %>% summarize(mean(fracusing))
cuse2
```

Here the `%>%` is called a "pipe", and it sends the output of the previous function to the input of the next function. This could also have been done in one step:

```{r}
mutate(cuse, fracusing = using / (using + notUsing)) %>%
  group_by(age) %>% 
  summarize(mean(fracusing))
```

Here the result is not stored anywhere; if you wanted to store it in a variable called `myanswer`, you could have started the above command with `myanswer <-` or `myanswer =`.

Also note that the line breaks are optional: you could put this all on one line, but breaking it up makes it more readable.

# Write on paper the model for expected probability of using birth control

Based on ```fit1```, write on paper the model for expected probability of using birth control? Don't forget the (inverse) logit function.

**Solution**

```{r}
fit1 <- glm(
  cbind(using, notUsing) ~ age + education + wantsMore,
  data = cuse,
  family = binomial("logit")
)
```

I'm going to store the coefficients of `fit1` in a new variable `b` just to save typing when writing out the formula, and round to two decimal places:

```{r}
bcoef <- round(coef(fit1), 2)
```

Here I'm going to take advantage of R Markdown's support for LaTeX formulae to write out the fitted regression model. I also use the \` r 2+2 \`     syntax (the result is `r 2+2`) for putting results of R code inline, instead of writing out numbers of the coefficients. I never wrote the number "four", but you'll have to look at the .Rmd to see how I did that! Doing this in reports allows you to update them as input data changes, without having to manually re-enter or copy numbers.

$P = \textit{logit}^{-1} \left( 
   `r bcoef["(Intercept)"]` + `r bcoef["age25-29"]` \times \textit{age25-29} + 
   `r bcoef["age30-39"]` \times \textit{age30-39} +
   `r bcoef["age40-49"]` \times \textit{age40-49} +
   `r bcoef["educationlow"]` \times \textit{educationlow} +
   `r bcoef["wantsMoreyes"]` \times \textit{wantsMoreyes} 
   \right)$

$\textit{logit}^{-1}(x) = \frac{1}{1+e^{-x}}$

# What is the expected probability...

Based on ```fit1```, what is the expected probability of an individual 25-29 years old, with high education, who wants more children, using birth control? Calculate it manually, and using `predict(fit1)`

**Solution**

This can be done using the `predict()` function, using a new `data.frame` giving the values that you want to predict for:
```{r}
invLogit <- function(x) 1/(1+exp(-x))
newdata=data.frame(age="25-29", education="high", wantsMore="yes")
invLogit( predict(fit1, newdata=newdata) )
```

By default, `predict()` predicts on the original data, and taking a look, I noticed that the 7th value is the one we want to predict on:
```{r}
invLogit( predict(fit1)[7] )
```

If we were really doing this manually, on paper, we would just calculate the linear predictor, then use the inverse logit function. Note that education="high" is the reference group, so we don't use it here:

```{r}
invLogit( bcoef["(Intercept)"] + bcoef["age25-29"] + bcoef["wantsMoreyes"] )
```

I don't *really* care, but if the remnant "(Intercept)" name there were annoying me, I would assign this to a variable then get rid of that name:

```{r}
res <- invLogit( bcoef["(Intercept)"] + bcoef["age25-29"] + bcoef["wantsMoreyes"] )
names(res) <- NULL
res
```

# Predicted odds ratio


Based on ```fit1```: Relative to women under 25 who want to have children, what is the predicted odds ratio for a woman 40-49 years old who does _not_ want to have children will be taking birth control?

**Solution**

```{r}
exp( coef(fit1)["age40-49"] - coef(fit1)["wantsMoreyes"])
```

# Likelihood Ratio Test

Using a likelihood ratio test, is there evidence that a model with interactions improves on ```fit1``` (no interactions)?

**Solution**

```{r}
fit1.int <- glm(cbind(using, notUsing) ~ age * education * wantsMore, 
           data=cuse, family=binomial("logit"))
anova(fit1, fit1.int, test="LRT")
```

# A model with interactions

Which, if any, variables have the strongest interactions? I use the "stargazer" package here which is extremely flexible for showing regression results from all kinds of models, capable of comparing multiple models or multiple dependent variables in the same table, and providing formatting customized to numerous journal styles.

**Solution**

We see here that the strongest interaction coeffient is for `age30-39:wantsMoreyes`. It is statistically significant and negative (`r round(coef(fit1.int)["age30-39:wantsMoreyes"], 2)`). It appears that being 30-39 years old and wanting more children has a multiplicative effect against using birth control, moreso than expected based on the age or wanting more children alone. 

The *stargazer* package is a good way to create nicely-formatted tables 
of regression results.

```{r, echo=FALSE, results="asis", message=FALSE}
library(stargazer)
stargazer(fit1, fit1.int, type="html", 
          dep.var.caption = " ",  #Otherwise the default is "Dependent Variable:"
          dep.var.labels = "Outcome: Using Birth Control",
          digits = 2,  #show 2 digits
          column.labels = c("No Interaction", "With Interactions"),
          ci=c(TRUE, TRUE), #show confidence intervals
          single.row=TRUE, #put results on a single line
          report="vc*s")  #report the "v"ariable name, "c"oefficient with significance "asterisks", and "s"tandard error (actually replaced by confidence interval because of ci argument above)
```

# Contrasts between every pair of age groups

Create a model matrix for a fit on age only, with contrasts between *every pair* of age groups. Between which age groups is the contrast significant?

**Solution**

## semi-manually

First, I'll do it manually, using the `multcomp` package and following an example from `?glht`. I'm not going to bother anymore creating pretty tables with `stargazer` though... 

```{r}
fit = glm(cbind(using, notUsing) ~ age, data=cuse, family=binomial("logit"))
coef(fit)
K <- rbind("25-29 - <25" = c(-1, 1, 0, 0),
           "30-39 - <25" = c(-1, 0, 1, 0),
           "40-49 - <25" = c(-1, 0, 0, 1),
           "30-39 - 25-29" = c(0, -1, 1, 0),
           "40-49 - 25-29" = c(0, -1, 0, 1),
           "40-49 - 30-39" = c(0, 0, -1, 1))
K
fit.all.cont = multcomp::glht(fit, linfct=K)
summary(fit.all.cont)
```

## Using Tukey contrasts

There is an easier way if you realize that these are the "Tukey" contrasts and use the `contrMat` function from the `multcomp` package:

```{r}
K2 = multcomp::contrMat(1:4, type="Tukey")
K2
fit.all.cont2 = multcomp::glht(fit, linfct=K2)
summary(fit.all.cont2)
```

We didn't get the same informative coefficient names this time, but we could have just by renaming the rows in `K2`, for example:

```{r}
rownames(K2) = rownames(K)
K2
summary( multcomp::glht(fit, linfct=K2) )
```

## Other contrast schemes

There are plenty of canned contrast schemes provided by `multcomp::contrMat`. Note use of the `example()` function to run all examples from the `contrmat()` function. This is a great example of how there are **many** ways to analyze one particular experimental design, but that you need to know design matrices to utilize many of them. 

In these examples, the first line `n <- c(10,20,30,40)` just signifies four levels, `n = 1:4` would do exactly the same thing.

```{r, message=FALSE}
library(multcomp)
example("contrMat")
```

